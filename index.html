<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>1-Gang Switch</title>
<style>
  :root{
    --bg:#f5f7fb; --plate:#ffffff; --stroke:#d5d9e2;
    --text:#0f172a; --muted:#64748b;
    --on:#22c55e; --off:#94a3b8;
    --ind-on:#3b82f6; --ind-off:#cbd5e1;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
  .wrap{height:100%;display:grid;place-items:center;padding:8px;}
  .panel{
    width:min(92vw,320px); aspect-ratio:1/1;
    background:var(--plate); border-radius:14px;
    box-shadow:0 6px 22px rgba(2,6,23,.12);
    display:grid; grid-template-columns:1fr; overflow:hidden;
    border:1px solid var(--stroke);
  }
  .key{
    position:relative; display:grid; grid-template-rows:1fr auto 16px; align-items:end;
    transition:background 0.2s;
  }
  .btn{
    margin:14px; border-radius:10px; border:1px solid var(--stroke);
    background:linear-gradient(#ffffff,#f3f6fb);
    box-shadow: inset 0 1px 0 #fff, 0 2px 6px rgba(15,23,42,.08);
    cursor:pointer; outline:none; transition:all .15s ease;
    height:90%;
  }
  .btn:active{transform:scale(0.98);}
  .label{
    text-align:center; font-size:14px; color:var(--muted); margin-bottom:8px;
    letter-spacing:.3px; user-select:none;
  }
  .dot{
    height:4px; width:24px; border-radius:999px; margin:0 auto 12px;
    background:var(--ind-off); transition:background-color .18s ease;
  }
  .key.on .btn{background:linear-gradient(#d9ffe7,#afffcb); border-color:#b7efc5;}
  .key.on .label{color:var(--on); font-weight:600;}
  .key.on .dot{background:var(--ind-on);}
  .btn:focus-visible{box-shadow:0 0 0 3px rgba(59,130,246,.35);}
  .head{
    position:absolute; top:8px; right:12px; color:#94a3b8; font-size:11px; letter-spacing:.2px;
  }
</style>
</head>
<body>
  
<div class="wrap">
  <div class="panel" id="panel">
    <div class="head">
      <span id="deviceId">device-unknown</span>
    </div>

    <div class="key" id="sw1">
      <button class="btn" id="btn-sw1"></button>
      <div class="label" id="status-sw1">OFF</div>
      <div class="dot"></div>
    </div>
  </div>
</div>

<script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
<script>
  const state = { sw1:false };

  function render(id){
    const key = document.getElementById(id);
    const status = document.getElementById(`status-${id}`);
    const on = state[id];
    key.classList.toggle("on", on);
    status.textContent = on ? "ON" : "OFF";
  }

  function toggle(id){
    state[id] = !state[id];
    render(id);
    window.parent?.postMessage({type:"era:command", id, value:state[id]}, "*");
  }

  document.getElementById('btn-sw1').addEventListener("click", ()=>toggle('sw1'));
  render('sw1');

  window.addEventListener("message",(event)=>{
    const msg = event.data||{};
    if(msg.type==="era:update" && msg.id==="sw1"){
      state.sw1=!!msg.value; render('sw1');
    }
    if(msg.type==="era:batch" && msg.data && 'sw1' in msg.data){
      state.sw1=!!msg.data.sw1; render('sw1');
      if(msg.deviceId) document.getElementById("deviceId").textContent=msg.deviceId;
    }
  });

  const btn_sw1 = document.getElementById('btn-sw1'); 
  let configLed = null, newStatusLed = null, actions = []; 
  const eraWidget = new EraWidget();
  eraWidget.init({
    needRealtimeConfigs: true,
    needHistoryConfigs: true,
    needActions: true,
    maxRealtimeConfigsCount: 1,
    maxHistoryConfigsCount: 1,
    maxActionsCount: 2,
    onConfiguration: (configuration) => {
      configLed = configuration.realtime_configs[0];
      actions = configuration.actions;
    },
    onValues: (values) => {
      if(!configLed || !values[configLed.id]) return;
      const stateLed = values[configLed.id].value;
      if (newStatusLed !== stateLed) {
        newStatusLed = stateLed;
        updateSwitch(stateLed);
      }
    },
  });

  function updateSwitch(state) {
    const key = document.getElementById("sw1");
    const label = document.getElementById("status-sw1");
    if(state === 1){
      key.classList.add("on");
      label.textContent = "ON";
    } else {
      key.classList.remove("on");
      label.textContent = "OFF";
    }
  }

  btn_sw1.addEventListener('click', () => {
    if (newStatusLed === 1) {
      eraWidget.triggerAction(actions[1]?.action, null);
    } else {
      eraWidget.triggerAction(actions[0]?.action, null);
    }
  });
</script>
</body>
</html>
